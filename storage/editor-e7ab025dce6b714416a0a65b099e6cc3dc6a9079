{"mode":"editor","version":1,"windowDimensions":{"x":1978,"y":71,"width":1543,"height":1101,"maximized":false},"grammars":{"deserializer":"GrammarRegistry","grammarOverridesByPath":{}},"project":{"paths":["c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp04822\\home\\ec2-user\\webapp\\views"],"buffers":[{"text":"//- 動画閲覧ページ\r\nextends layout\r\nblock head\r\n  meta(name='description', content='#{videoInfo.title} | ベストなエロ動画「べすえろ」は美少女、女子高生、無修正、台湾、イラマチオ、電気拷問、素人など何でもありの無料エロ動画サイトです。FC2動画とxideos.comを毎日配信中！')\r\n  title #{videoInfo.title} | ベストなエロ動画「べすえろ」 | 美少女、女子高生、無修正、台湾、イラマチオ、電気拷問、素人など何でもあり！\r\n\r\nblock content\r\n  .wrapper\r\n    .main.watch-content\r\n      #ad-upper-video\r\n        //- 忍者ad\r\n        script(src='http://adm.shinobi.jp/s/91b2a983d4315fdb236632e76604e9d0')\r\n        //- Rin凜\r\n        //- script(type='text/javascript', src='http://sp-js.rinad.jp/mod/4ea137c7b914d1be98db2485c9339257_inline.js?pid=1100001328&sid=1100004076&lang=ja', charset='utf-8')\r\n        //- dti\r\n        //- a(href='http://click.dtiserv2.com/Click/2006005-6-174291', target='_blank')\r\n        //-   img(src='http://affiliate.dtiserv.com/image/carib/06-460-03.gif', border='0')\r\n        //- adDeluxe\r\n        //- script(language='javascript', type='text/javascript').\r\n        //-   var addeluxue_conf = {site:14963091,frame:10,width:320,height:50,color:[\"999999\",\"FFFFFF\",\"2200CC\",\"F25D5D\",\"671F28\"],host:'adv.addeluxe.jp',ver:1.5};\r\n        //- script(language='javascript', type='text/javascript', src='http://img.addeluxe.jp/js/iframe/adv.js', charset='utf-8')\r\n\r\n      div(class='value iframeBox iframeBox-#{videoInfo.site}')\r\n        != videoInfo.embed_tag\r\n\r\n      .box.video-info\r\n        h4.title= videoInfo.title\r\n        .row\r\n          .col-xs-12\r\n            span.glyphicon.glyphicon-tag\r\n            each category in videoInfo.category_names\r\n              a.category.btn.btn-danger(href='/videos/popular/#{category}')= category\r\n\r\n      //- ピックアップビデオ\r\n      .box.pickup-videos\r\n        span.glyphicon.glyphicon-bullhorn\r\n        | ピックアップ\r\n        hr\r\n        -var rows = pickupVideos\r\n        include inc_box_videos\r\n\r\n      //- 内部リンクBOX\r\n      include inc_internal_link_box\r\n\r\n    .sub.related-videos\r\n      .one-row\r\n        //- Ad\r\n        #ad-wrapper.box\r\n          span.glyphicon.glyphicon-link\r\n          a(href='http://click.dtiserv2.com/Click4/1-458-174291' target='_blank') こいつで100回はヌケル！！【天然むすめ】\r\n          hr\r\n          //- 忍者ad\r\n          script(src='http://adm.shinobi.jp/s/8420956f88b31884588a97ac734ae339')\r\n          //- DTI PPC3\r\n          //- .pc-only\r\n          //-   IFRAME(SRC=\"http://www.ppc-direct.com/index25.html?affid=174291\" width=\"300\" height=\"250\" frameborder=\"no\" scrolling=\"no\")\r\n          //- adDeluxe\r\n          //- script(language='javascript', type='text/javascript').\r\n          //-   var addeluxue_conf = {site:14963091,frame:16,width:300,height:250,color:[\"999999\",\"FFFFFF\",\"2200CC\",\"F25D5D\",\"671F28\"],host:'adv.addeluxe.jp',ver:1.5};\r\n          //- script(language='javascript', type='text/javascript', src='http://img.addeluxe.jp/js/iframe/adv.js', charset='utf-8')\r\n          //- DTI カリビアン\r\n          //- a(href='http://click.dtiserv2.com/Click10/1006001-6-174291', target='_blank')\r\n          //-   img(src='http://affiliate.dtiserv.com/image/carib/newmovie.jpg', border='0')\r\n          br\r\n          br\r\n          //- rin\r\n          script(type='text/javascript', src='http://sp-js.rinad.jp/mod/4ea137c7b914d1be98db2485c9339257_inline.js?pid=1100001328&sid=1100004076&lang=ja', charset='utf-8')\r\n\r\n        .box\r\n          span.glyphicon.glyphicon-link\r\n          | 優良サイト様（外部リンク）\r\n          hr\r\n          ul\r\n            li\r\n              a(href='http://www.kami-douga-adult.com/' target='_blank') 神動画.com\r\n            li\r\n              a(href='http://adultcity.to/in/11224/' target='_blank') アダルトシティ\r\n              \r\n\r\n      //- 関連ビデオ\r\n      .box\r\n        span.glyphicon.glyphicon-link\r\n        | あなたへのオススメ\r\n        hr\r\n        -var rows = relatedInfo\r\n        include inc_box_videos\r\n\r\n    //- 人気カテゴリbox\r\n    .bottom\r\n      include inc_popular_categories_box\r\n\r\n//- block scripts\r\n  //- script(type='text/javascript').\r\n    //- $(document).ready(function() {\r\n      //- $('.iframeBox-fc2 div:first-child').css('height', '392px');\r\n    //- });\r\n","markers":{"markers":{"1":{"id":1,"range":[[6,13],[6,13]],"tailed":false,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":246,"goalBufferRange":null,"preserveFolds":true},"deserializer":"Marker"},"59":{"id":59,"range":[[5,0],[5,0]],"tailed":true,"reversed":false,"valid":true,"invalidate":"overlap","persistent":true,"properties":{},"deserializer":"Marker"},"95":{"id":95,"range":[[8,23],[8,23]],"tailed":true,"reversed":false,"valid":true,"invalidate":"overlap","persistent":true,"properties":{},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[],"redoStack":[],"deserializer":"History"},"encoding":"utf8","filePath":"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp28272\\home\\ec2-user\\webapp\\views\\watch.jade","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"62e6bb4ed3d45c973adb776ac40c881171e0798b","deserializer":"TextBuffer"},{"text":"doctype html\r\nhtml\r\n  head\r\n    meta(charset='UTF-8')\r\n    meta(name='viewport', content='width=device-width, initial-scale=1')\r\n    meta(name='keywords', content='美少女,フェラ,女子高生,無修正,巨乳,イラマチオ,ハメ撮り,素人,FC2,xvideos,スマホ')\r\n\r\n    link(rel='icon', type='image/vnd.microsoft.icon', href='/img/favicon.ico')\r\n    link(rel='stylesheet', href='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css')\r\n    link(rel='stylesheet', href='/css/jquery.sidr.dark.css')\r\n    link(rel='stylesheet', href='/css/layout.css')\r\n    block head\r\n      meta(name='description', content='ベストなエロ動画「べすえろ」は美少女、女子高生、無修正、台湾、イラマチオ、電気拷問、素人など何でもありの無料エロ動画サイトです。FC2動画とxideos.comなど毎日配信中！')\r\n      title  ベストなエロ動画「べすえろ」 | 美少女、女子高生、無修正、台湾、イラマチオ、電気拷問、素人など何でもあり！\r\n  body\r\n    //- header\r\n    .navbar.navbar-inverse(role='navigation')\r\n      .container\r\n        .navbar-header\r\n          a(href='/')\r\n            img#title-logo(src='/img/title.png' width='260' alt='ベストなエロ動画「べすえろ」')\r\n        .navbar-collapse.collapse\r\n          ul.nav.navbar-nav\r\n            li\r\n              a(href='/add/video/url/form' title=\"Add a Movie\")\r\n                span.glyphicon.glyphicon-plus\r\n                | 投稿する\r\n            li\r\n              a(href='/videos/new/全カテゴリ')\r\n                span.glyphicon.glyphicon-facetime-video\r\n                | 新作\r\n            li\r\n              a(href='/videos/popular/全カテゴリ')\r\n                span.glyphicon.glyphicon-facetime-video\r\n                | 総合BEST\r\n            li\r\n              a(href='/videos/popular/全カテゴリ?term=604800')\r\n                span.glyphicon.glyphicon-facetime-video\r\n                | 週間BEST\r\n            li\r\n              a(href='http://goo.gl/forms/SK6WUsWMCu' target='_blank')\r\n                span.glyphicon.glyphicon-pencil\r\n                | フィードバック\r\n        //- .nav-collapse\r\n        #sidr\r\n          ul.nav.navbar-nav\r\n            li\r\n              a(href='/add/video/url/form')\r\n                span.glyphicon.glyphicon-plus\r\n                | 投稿する\r\n            li\r\n              a(href='/videos/new/全カテゴリ')\r\n                span.glyphicon.glyphicon-facetime-video\r\n                | 新作\r\n            li\r\n              a(href='/videos/popular/全カテゴリ')\r\n                span.glyphicon.glyphicon-facetime-video\r\n                | 総合BEST\r\n            li\r\n              a(href='/videos/popular/全カテゴリ?term=604800')\r\n                span.glyphicon.glyphicon-facetime-video\r\n                | 週間BEST\r\n            li\r\n              a(href='http://goo.gl/forms/SK6WUsWMCu' target='_blank')\r\n                span.glyphicon.glyphicon-pencil\r\n                | フィードバック\r\n\r\n    //- Page Topボタン\r\n    #btn-page-top.btn.btn-default.btn-lg\r\n      .glyphicon.glyphicon-circle-arrow-up\r\n\r\n    //- メニュー開閉ボタン（補助）\r\n    #btn-navbar-toggle.btn.btn-default.btn-lg.sidr-toggle\r\n      .glyphicon.glyphicon-align-justify\r\n\r\n\r\n    block header\r\n\r\n    .content-main\r\n      block content\r\n\r\n    .content-sidebar\r\n      block sidebar\r\n\r\n    .content-footer\r\n      //- #mobile-ad-footer\r\n      //-   a(href='http://clicks.pipaffiliates.com/afs/come.php?id=535&cid=46039&atype=1&ctgid=16' target='_blank')\r\n      //-     img(src='http://ads.pipaffiliates.com/afs/show.php?id=535&cid=46039&ctgid=16', width='600', height='90', border='0')\r\n\r\n      block footer\r\n\r\n    script(src='//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js', charset='UTF-8')\r\n    script(src='/js/vendor/jquery.sidr.min.js', charset='UTF-8')\r\n    script(src='//cdnjs.cloudflare.com/ajax/libs/masonry/3.2.1/masonry.pkgd.min.js', charset='UTF-8')\r\n    script(src='/js/vendor/imagesloaded.min.js', charset='UTF-8')\r\n    //- script(src='http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js', charset='UTF-8')\r\n    //- script(src='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js', charset='UTF-8')\r\n\r\n    //- Google Analytics\r\n    script(type='text/javascript').\r\n      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){\r\n      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),\r\n      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)\r\n      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');\r\n\r\n      ga('create', 'UA-35884309-3', 'auto');\r\n      ga('require', 'displayfeatures');\r\n      ga('send', 'pageview');\r\n\r\n    //- admax\r\n    //- script(src='http://adm.shinobi.jp/s/6215edf0424c2d07b5165cafd509478e')\r\n    //- rin\r\n    script(type='text/javascript', src='http://sp-js.rinad.jp/mod/4ea137c7b914d1be98db2485c9339257.js?pid=1100001328&sid=1100004076&lang=ja', charset='utf-8')\r\n\r\n\r\n    //- Page Top Btn\r\n    script(type='text/javascript').\r\n      var $btnPageTop = $('#btn-page-top');\r\n      $(document).ready(function() {\r\n        $btnPageTop.bind('touchstart mousedown', function(e) {\r\n          e.stopPropagation(); e.preventDefault();\r\n          $('body').animate({scrollTop:0}, 'normal', 'swing');\r\n        });\r\n      });\r\n\r\n    //- script load\r\n    script(src='/js/layout.js', charset='UTF-8')\r\n    block scripts\r\n","markers":{"markers":{"1":{"id":1,"range":[[19,21],[19,21]],"tailed":false,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":268,"goalBufferRange":null},"deserializer":"Marker"},"14":{"id":14,"range":[[19,20],[19,21]],"tailed":true,"reversed":false,"valid":true,"invalidate":"overlap","persistent":true,"properties":{},"deserializer":"Marker"},"15":{"id":15,"range":[[19,11],[19,12]],"tailed":true,"reversed":false,"valid":true,"invalidate":"overlap","persistent":true,"properties":{},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[],"redoStack":[],"deserializer":"History"},"encoding":"utf8","filePath":"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp04822\\home\\ec2-user\\webapp\\views\\layout.jade","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"7f7c59335be1ed587f73d1b5fd79c13be11d9d0d","deserializer":"TextBuffer"},{"text":"var async  = require('async');\r\nvar _ = require('underscore');\r\nvar scrapingClient = require('cheerio-httpcli');\r\nvar ay = require('../utils/ay');\r\nvar Deferred = require('JQDeferred');\r\nvar redisCli = require('redis').createClient();\r\nvar crud = require('../models/crud');\r\nvar globalVar = require('../utils/globalVar');\r\n\r\n// 画像保存パス定義\r\nvar PUBLIC_PATH = 'public';\r\nvar THUMB_PATH = '/img/thumbs/'; // 後にsite文字列をconcatする ex) thumbs/fc2/\r\n\r\n// 総合、新着ランキングのString\r\nvar NAME_GENGERAL_CATEGORIES = '全カテゴリ';\r\nvar PARAMS_GENGERAL = NAME_GENGERAL_CATEGORIES; // getリクエスト時に全カテゴリを示す文字列\r\n\r\n// テキスト用の人気カテゴリをいくつまでとってくるか\r\nvar MAX_POPULAR_CATEGORY_NUM = 35;\r\n// (TOPページ専用)人気カテゴリboxをいくつ表示するか\r\nvar MAX_POPULAR_CATEGORY_BOX_NUM = 10;\r\n// (TOPページ)全カテゴリでいくつビデオを読み込むか\r\nvar MAX_TOP_GENERAL_VIDEO_NUM = 10;\r\n// (TOPページ)各カテゴリでいくつずつビデオを読み込むか\r\nvar MAX_TOP_CATEGORY_VIDEO_NUM = 15;\r\n// 「関連動画（オススメ）」をいくつまでとってくるか\r\nvar MAX_RECOMMEND_NUM = 60;\r\n// ピックアップに何本表示するか\r\nvar PICKUP_VIDEOS_NUM = 4;\r\n// 一時データをどの程度保存しておくか\r\nvar DURATION_TMP_FORM = 60 * 60 * 24;\r\n\r\nexports.index = function(req, res) {\r\n\t// 人気カテゴリ５つくらいboxを用意して、そこへ１０本くらいずつデータを流す\r\n\tvar popularCategories;\r\n\tvar categoryDeferred = new Deferred();\r\n\tvar data = {}; // テンプレートに渡すobject\r\n\r\n\tcrud.findPopularCategories({ limit: MAX_POPULAR_CATEGORY_NUM }, function(err, rows) {\r\n\t\tif (err) {\r\n\t\t\tres.redirect(500, '/error?message=' + err);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// rowsを整形して、人気カテゴリ配列にする\r\n\t\tvar popularCategoriesArr = _.pluck(rows, 'name');\r\n\r\n\t\t// カテゴリ表示用の配列と、動画取得用の配列に分ける\r\n\t\tdata.popularCategories = popularCategoriesArr;\r\n\t\tpopularCategories = _.first(popularCategoriesArr, MAX_POPULAR_CATEGORY_BOX_NUM);\r\n\r\n\t\tcategoryDeferred.resolve();\r\n\t});\r\n\r\n\tcategoryDeferred.done(function() {\r\n\t\t// 総合新着\r\n\t\tvar generalRanking = function(cb) {\r\n\t\t\tcrud.findAll({ where: 'v.is_deleted = 0', limit: MAX_TOP_GENERAL_VIDEO_NUM }, function(err, rows) {\r\n\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\tay.prettyRows(rows);\r\n\t\t\t\tcb(null, rows);\r\n\t\t\t});\r\n\t\t};\r\n\t\t// カテゴリ別新着\r\n\t\tvar categoryRanking = _.map(popularCategories, function(category) {\r\n\t\t\treturn function(cb) {\r\n\t\t\t\tcrud.findAllByCategory(category, { where: 'v.is_deleted = 0', limit: MAX_TOP_CATEGORY_VIDEO_NUM }, function(err, rows) {\r\n\t\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\t\tay.prettyRows(rows);\r\n\t\t\t\t\tcb(null, rows);\r\n\t\t\t\t});\r\n\t\t\t};\r\n\t\t});\r\n\t\t// async.parallelの引数となる関数を生成する\r\n\t\tvar functions = _.union([generalRanking], categoryRanking);\r\n\r\n\t\tasync.parallel(\r\n\t\t\tfunctions,\r\n\t\t\tfunction(err, results) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tres.redirect(500, '/error?message=' + err);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 総合。parallelで配列で引数渡しているのでresults[0]に必ず総合ランキングが入る\r\n\t\t\t\tdata.general = results.shift();\r\n\t\t\t\tdata.generalRankingName = NAME_GENGERAL_CATEGORIES;\r\n\t\t\t\t// 1度表示した物は再度表示しない（先出優先）。まずは全カテゴリのIDリストを取得\r\n\t\t\t\tvar videoIdList = {};\r\n\t\t\t\t_.each(_.pluck(data.general, 'id'), function(id) {\r\n\t\t\t\t\tvideoIdList[id] = true;\r\n\t\t\t\t});\r\n\t\t\t\t// カテゴリ別\r\n\t\t\t\tdata.categories = [];\r\n\t\t\t\t_.each(results, function(rows, key) {\r\n\t\t\t\t\trows = _.reject(rows, function(row) {\r\n\t\t\t\t\t\tif (_.has(videoIdList, row.id)) {\r\n\t\t\t\t\t\t\treturn true; // IDリストに存在したらreject\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideoIdList[row.id] = true; // 存在しなければIDリストに追加\r\n\t\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tdata.categories[key] = { name: popularCategories[key], rows: rows };\r\n\t\t\t\t});\r\n\r\n\t\t\t\tres.render('index', data);\r\n\t\t\t}\r\n\t\t);\r\n\t});\r\n};\r\n\r\n\r\n// 新着順に動画を取得\r\nvar readNewVideos = function(categoryName, page, readDeferred) {\r\n\t// 全カテゴリあるいは各カテゴリから新着を選ぶ\r\n\tif (categoryName === PARAMS_GENGERAL) {\r\n\t\tcategoryName = NAME_GENGERAL_CATEGORIES;\r\n\t\tcrud.findAll({ order: 'v.id', page: page, where: 'v.is_deleted = 0' }, function(err, rows) {\r\n\t\t\tif (err) return readDeferred.reject(err);\r\n\t\t\treadDeferred.resolve(rows);\r\n\t\t});\r\n\t} else {\r\n\t\tcrud.findAllByCategory(categoryName, { order: 'v.id', page: page, where: 'v.is_deleted = 0' }, function(err, rows) {\r\n\t\t\tif (err) return readDeferred.reject(err);\r\n\t\t\treadDeferred.resolve(rows);\r\n\t\t});\r\n\t}\r\n};\r\nexports.videosNew = function(req, res) {\r\n\tvar categoryName = req.params.categoryName;\r\n\tvar page = (req.query.page) ? req.query.page : 1;\r\n\tvar readDeferred = new Deferred();\r\n\tvar categoryDeferred = new Deferred();\r\n\r\n\treadNewVideos(categoryName, page, readDeferred);\r\n\r\n\tcrud.findPopularCategories({ limit: MAX_POPULAR_CATEGORY_NUM }, function(err, rows) {\r\n\t\tif (err) return categoryDeferred.reject(err);\r\n\r\n\t\t// rowsを整形して、人気カテゴリ配列にする\r\n\t\tcategoryDeferred.resolve(_.pluck(rows, 'name'));\r\n\t});\r\n\r\n\tDeferred.when(readDeferred, categoryDeferred)\r\n\t\t.done(function(rows, popularCategories) {\r\n\t\t\tay.prettyRows(rows);\r\n\t\t\tres.render('videosCategory', {\r\n\t\t\t\ttype: 'v.id',\r\n\t\t\t\tcategoryName: categoryName,\r\n\t\t\t\trows: rows,\r\n\t\t\t\tpopularCategories: popularCategories\r\n\t\t\t});\r\n\t\t})\r\n\t\t.fail(function(err) {\r\n\t\t\tres.redirect(500, '/error?message=' + err);\r\n\t\t});\r\n};\r\n// AJAXローディングに使う。重複多いのでどうにかしたい。\r\nexports.videosNewLoad = function(req, res) {\r\n\tvar categoryName = req.params.categoryName;\r\n\tvar page = req.query.page;\r\n\tvar readDeferred = new Deferred();\r\n\r\n\treadNewVideos(categoryName, page, readDeferred);\r\n\r\n\treadDeferred\r\n\t\t.done(function(rows) {\r\n\t\t\tay.prettyRows(rows);\r\n\t\t\tres.render('inc_box_videos_rows', { rows: rows });\r\n\t\t})\r\n\t\t.fail(function(err) {\r\n\t\t\tres.redirect(500, '/error?message=' + err);\r\n\t\t});\r\n};\r\n\r\n\r\n// カテゴリ別動画一覧（総合人気ランキングも含む）\r\nvar readPopularVideos = function(categoryName, order, page, readDeferred) {\r\n\tif (categoryName === PARAMS_GENGERAL) {\r\n\t\tcategoryName = NAME_GENGERAL_CATEGORIES;\r\n\t\tcrud.findAll({ order: order, page: page, where: 'v.is_deleted = 0' }, function(err, rows) {\r\n\t\t\tif (err) return readDeferred.reject(err);\r\n\t\t\treadDeferred.resolve(rows);\r\n\t\t});\r\n\t} else {\r\n\t\tcrud.findAllByCategory(categoryName, { order: order, page: page, where: 'v.is_deleted = 0' }, function(err, rows) {\r\n\t\t\tif (err) return readDeferred.reject(err);\r\n\t\t\treadDeferred.resolve(rows);\r\n\t\t});\r\n\t}\r\n};\r\nexports.videosPopular = function(req, res) {\r\n\tvar categoryName = req.params.categoryName;\r\n\tvar order = ay.convertTermToQuery(req.query.term);\r\n\tvar page = (req.query.page) ? req.query.page : 1;\r\n\tvar readDeferred = new Deferred();\r\n\tvar categoryDeferred = new Deferred();\r\n\r\n\treadPopularVideos(categoryName, order, page, readDeferred);\r\n\r\n\tcrud.findPopularCategories({ limit: MAX_POPULAR_CATEGORY_NUM }, function(err, rows) {\r\n\t\tif (err) return categoryDeferred.reject(err);\r\n\r\n\t\t// rowsを整形して、人気カテゴリ配列にする\r\n\t\tcategoryDeferred.resolve(_.pluck(rows, 'name'));\r\n\t});\r\n\r\n\t// DBから取得が終わったら。\r\n\tDeferred.when(readDeferred, categoryDeferred)\r\n\t\t.done(function(rows, popularCategories) {\r\n\t\t\tay.prettyRows(rows);\r\n\t\t\tres.render('videosCategory', {\r\n\t\t\t\ttype: order,\r\n\t\t\t\tcategoryName: categoryName,\r\n\t\t\t\trows: rows,\r\n\t\t\t\tpopularCategories: popularCategories\r\n\t\t\t});\r\n\t\t})\r\n\t\t.fail(function(err) {\r\n\t\t\tres.redirect(500, '/error?message=' + err);\r\n\t\t});\r\n};\r\n// AJAXローディングに使う。重複多いのでどうにかしたい。\r\nexports.videosPopularLoad = function(req, res) {\r\n\tvar categoryName = req.params.categoryName;\r\n\tvar order = ay.convertTermToQuery(req.query.term);\r\n\tvar page = req.query.page;\r\n\tvar readDeferred = new Deferred();\r\n\r\n\treadPopularVideos(categoryName, order, page, readDeferred);\r\n\r\n\treadDeferred\r\n\t\t.done(function(rows) {\r\n\t\t\tay.prettyRows(rows);\r\n\t\t\tres.render('inc_box_videos_rows', { rows: rows });\r\n\t\t})\r\n\t\t.fail(function(err) {\r\n\t\t\tres.redirect(500, '/error?message=' + err);\r\n\t\t});\r\n};\r\n\r\n\r\n// 各動画閲覧ページ\r\nexports.watch = function(req, res) {\r\n\tvar TIMER_NAME_ALL = 'watchAll';\r\n\tvar TIMER_NAME_ASYNC_END = 'asyncEnd';\r\n\tvar TIMER_NAME_FIND = 'byId';\r\n\tvar TIMER_NAME_FIND_BY_CATEGORY = 'byCategory';\r\n\tconsole.time(TIMER_NAME_ALL);\r\n\tconsole.time(TIMER_NAME_ASYNC_END);\r\n\tvar videoID = req.params.videoID;\r\n\tvar categories = req.params.videoCategories;\r\n\tif (categories) categories = categories.split(',');\r\n\r\n\tasync.parallel([\r\n\t\t// ビデオ情報を取得\r\n\t\tfunction(cb) {\r\n\t\t\tconsole.time(TIMER_NAME_FIND);\r\n\t\t\tcrud.findVideo(videoID, function(err, rows) {\r\n\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\tay.prettyRows(rows);\r\n\t\t\t\tconsole.timeEnd(TIMER_NAME_FIND);\r\n\t\t\t\tcb(null, rows);\r\n\t\t\t});\r\n\t\t},\r\n\t\t// 関連動画情報を取得\r\n\t\tfunction(cb) {\r\n\t\t\tconsole.time(TIMER_NAME_FIND_BY_CATEGORY);\r\n\t\t\tcrud.findAllByCategory(categories, { where: 'v.is_deleted = 0', limit: MAX_RECOMMEND_NUM, order: 'v.id' }, function(err, rows) {\r\n\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\tay.prettyRows(rows);\r\n\t\t\t\tconsole.timeEnd(TIMER_NAME_FIND_BY_CATEGORY);\r\n\t\t\t\tcb(null, rows);\r\n\t\t\t});\r\n\t\t},\r\n\t\t// 人気カテゴリを取得\r\n\t\tfunction(cb) {\r\n\t\t\tcrud.findPopularCategories({ limit: MAX_POPULAR_CATEGORY_NUM }, function(err, rows) {\r\n\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\t// rowsを整形して、人気カテゴリ配列にする\r\n\t\t\t\tcb(null, _.pluck(rows, 'name'));\r\n\t\t\t});\r\n\t\t}\r\n\t], function(err, results) {\r\n\t\tif (err) {\r\n\t\t\tres.redirect(500, '/error?message=' + err);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconsole.timeEnd(TIMER_NAME_ASYNC_END);\r\n\r\n\t\t// 再生回数をカウントアップ（callbackを待つ必要が無いのでここで）\r\n\t\tcrud.incrView(videoID, function(err, result){ /* nothing todo */ });\r\n\t\t// 関連動画からwatch中の動画を削除\r\n\t\tvar watchVideo = results[0][0];\r\n\t\tvar relatedVideos = results[1];\r\n\t\t// 視聴中のビデオは関連動画から除外する\r\n\t\trelatedVideos = _.reject(relatedVideos, function(video) {\r\n\t\t\treturn video.id === watchVideo.id;\r\n\t\t});\r\n\t\t// 関連動画の中から数本をランダムに抽出して、first-viewに収める\r\n\t\tvar pickupVideos = _.chain(relatedVideos)\r\n\t\t\t.sample(PICKUP_VIDEOS_NUM)\r\n\t\t\t.value();\r\n\t\t// relatedVideosからピックアップビデオを除外\r\n\t\trelatedVideos = _.reject(relatedVideos, function(relatedVideo) {\r\n\t\t\tif (_.findWhere(pickupVideos, { id: relatedVideo.id })) {\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tres.render('watch', { videoInfo: watchVideo, relatedInfo: relatedVideos, popularCategories: results[2], pickupVideos: pickupVideos });\r\n\t\tconsole.timeEnd(TIMER_NAME_ALL);\r\n\t});\r\n};\r\n\r\n\r\n// 動画URLフォームページ\r\nexports.addVideoURLForm = function(req, res) {\r\n\t\tres.render('addVideoURLForm');\r\n};\r\n\r\nexports.addVideoForm = function(req, res) {\r\n\tvar url = req.query.Url || '';\r\n\tvar siteTypeInt = ay.getSiteTypeInt(url);\r\n\r\n\t// Error処理\r\n\tif (siteTypeInt === -1) {\r\n\t\tvar message = '有効なURLを入力してください';\r\n\t\tres.redirect(302, '/add/video/url/form?message=' + message);\r\n\t}\r\n\r\n\t// この時点では登録確定していないので、UniqueIDをkeyにしてredisとかに一時保存\r\n\t// uniqueID: { site, url, thumbUrl, embedTag }\r\n\tvar uniqueID = ay.createUniqueID();\r\n\tvar redisData = {}; // redisにsetするobject\r\n\tvar videoData = {}; // urlをもとにfetchしたデータを入れる\r\n\tasync.parallel([\r\n\t\t// スクレイピングにより情報を取得\r\n\t\tfunction(cb) {\r\n\t\t\t// DEBUG\r\n\t\t\tredisData.site = siteTypeInt;\r\n\t\t\tay.fetchSite(siteTypeInt, url, videoData, cb);\r\n\t\t},\r\n\t\t// カテゴリのsuggestのためのデータを取得\r\n\t\tfunction(cb) {\r\n\t\t\tcrud.findPopularCategories({ limit: 100 }, function(err, rows) {\r\n\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\t// rowsを整形して、人気カテゴリ配列にする\r\n\t\t\t\tcb(null, _.pluck(rows, 'name'));\r\n\t\t\t});\r\n\t\t}\r\n\t], function(err, results) {\r\n\t\tif (err) {\r\n\t\t\tres.redirect(302, '/add/video/url/form?message=' + err);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// redisに一時保存データをset\r\n\t\tredisData.url = url;\r\n\t\tredisData.thumbUrl = videoData.thumbUrl;\r\n\t\tredisData.embedTag = videoData.embedTag;\r\n\t\tredisData.title = videoData.title;\r\n\t\tredisCli.set(uniqueID, JSON.stringify(redisData));\r\n\t\tredisCli.expire(uniqueID, DURATION_TMP_FORM);\r\n\r\n\t\t// 動画投稿フォームページ\r\n\t\tres.render('addVideoForm', {\r\n\t\t\tuniqueID: uniqueID,\r\n\t\t\turl: url,\r\n\t\t\tthumbUrl: videoData.thumbUrl,\r\n\t\t\tembedTag: videoData.embedTag,\r\n\t\t\ttitle: videoData.title,\r\n\t\t\tsite: ay.siteToChar(redisData.site),\r\n\t\t\tcategories: results[1]\r\n\t\t});\r\n\t});\r\n};\r\n\r\n\r\n// Videoの追加　TODO　新Categories\r\nexports.addVideo = function(req, res) {\r\n\t// これをキーにして一時保存情報を取り出す。\r\n\tvar uniqueID = req.params.uniqueID;\r\n\r\n\tconsole.log('req.body', req.body);\r\n\r\n\r\n\tif (!req.body.category) {\r\n\t\tvar message = 'カテゴリは必須入力です。';\r\n\t\tres.redirect(302, '/add/video/url/form?message=' + message);\r\n\t}\r\n\r\n\tasync.waterfall([\r\n\t\t// redisから一時保存データを取得\r\n\t\tfunction(cb) {\r\n\t\t\tredisCli.get(uniqueID, function(err, res) {\r\n\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\tcb(null, JSON.parse(res));\r\n\t\t\t});\r\n\t\t},\r\n\t\t// DBへ保存\r\n\t\tfunction(redisData, cb) {\r\n\t\t\tvar saveDir = THUMB_PATH + ay.siteToChar(redisData.site) + '/';\r\n\t\t\tvar thumbPath = saveDir + uniqueID + '.jpg';\r\n\t\t\t// titleが空で無ければそれを使う。\r\n\t\t\tif (req.body.title) redisData.title = req.body.title;\r\n\r\n\t\t\tcrud.saveVideo(redisData, thumbPath, req.body.comment, req.body.author, function(err, result) {\r\n\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\tvar thumbData = { thumbUrl: redisData.thumbUrl, thumbPath: thumbPath };\r\n\t\t\t\tcb(null, result.insertId, thumbData);\r\n\t\t\t});\r\n\t\t},\r\n\t\t// カテゴリテーブルへ保存\r\n\t\tfunction(insertId, thumbData, cb) {\r\n\t\t\t// カテゴリの整形\r\n\t\t\tvar categories = req.body.category.trim().replace(/　+/g,\" \").replace(/ +/g,\" \").split(' ');\r\n\t\t\tcategories = _.uniq(categories);\r\n\t\t\tvar values = _.map(categories, function(category) {return [insertId, category];});\r\n\r\n\t\t\tcrud.saveCategories(values, function(err, result) {\r\n\t\t\t\tif (err) return cb(err);\r\n\r\n\t\t\t\tcb(null, thumbData);\r\n\t\t\t});\r\n\t\t},\r\n\t\t// サムネイル画像を取得してディスクに保存\r\n\t\tfunction(thumbData, cb) {\r\n\t\t\tay.downloadBinary(thumbData.thumbUrl, PUBLIC_PATH + thumbData.thumbPath, function(isSuccess) {\r\n\t\t\t\tif (!isSuccess) return cb('サムネイル画像保存に失敗しました');\r\n\t\t\t\tcb(null);\r\n\t\t\t});\r\n\t\t}\r\n\t], function(err, result) {\r\n\t\tif (err) {\r\n\t\t\tres.redirect(302, '/add/video/url/form?message=' + err);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconsole.log('registered!!', result);\r\n\t\t// TODO どこに飛ばす？\r\n\t\tres.redirect(302, '/');\r\n\t});\r\n};\r\n\r\n\r\n// 汎用エラーページ\r\nexports.error = function(req, res) {\r\n\tconsole.log('###err: ', req.query.message);\r\n\tres.render('error');\r\n};\r\n","markers":{"markers":{"1":{"id":1,"range":[[50,0],[50,0]],"tailed":false,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":292,"goalBufferRange":null},"deserializer":"Marker"},"4":{"id":4,"range":[[50,0],[50,0]],"tailed":true,"reversed":false,"valid":true,"invalidate":"overlap","persistent":true,"properties":{},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[],"redoStack":[],"deserializer":"History"},"encoding":"utf8","filePath":"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp15188\\home\\ec2-user\\webapp\\routes\\index.js","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"cb83e9c7a93a97074b38073d82897e0c6a2fc033","deserializer":"TextBuffer"}],"deserializer":"Project"},"workspace":{"paneContainer":{"root":{"id":3,"items":[{"deserializer":"SettingsView","version":2,"activePanelName":"jshint","uri":"atom://config"},{"id":292,"softTabs":false,"displayBuffer":{"id":293,"softWrapped":true,"editorWidthInChars":null,"scrollTop":632,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp15188\\home\\ec2-user\\webapp\\routes\\index.js","invisibles":{"cr":" ","eol":" ","space":"·","tab":"»"},"deserializer":"TokenizedBuffer"},"invisibles":{"cr":" ","eol":" ","space":"·","tab":"»"},"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":246,"softTabs":true,"displayBuffer":{"id":247,"softWrapped":true,"editorWidthInChars":null,"scrollTop":0,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp28272\\home\\ec2-user\\webapp\\views\\watch.jade","invisibles":{"cr":" ","eol":" ","space":"·","tab":"»"},"deserializer":"TokenizedBuffer"},"invisibles":{"cr":" ","eol":" ","space":"·","tab":"»"},"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"id":268,"softTabs":true,"displayBuffer":{"id":269,"softWrapped":true,"editorWidthInChars":null,"scrollTop":0,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp04822\\home\\ec2-user\\webapp\\views\\layout.jade","invisibles":{"cr":" ","eol":" ","space":"·","tab":"»"},"deserializer":"TokenizedBuffer"},"invisibles":{"cr":" ","eol":" ","space":"·","tab":"»"},"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"}],"activeItemUri":"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp15188\\home\\ec2-user\\webapp\\routes\\index.js","focused":true,"deserializer":"Pane"},"activePaneId":3,"deserializer":"PaneContainer","version":1},"fullScreen":false,"packagesWithActiveGrammars":["language-javascript","language-jade","language-hyperlink","language-todo"],"deserializer":"Workspace"},"packageStates":{"fuzzy-finder":{"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp15188\\home\\ec2-user\\webapp\\routes\\index.js":1418530537533,"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp28272\\home\\ec2-user\\webapp\\views\\watch.jade":1418530480094,"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp04822\\home\\ec2-user\\webapp\\views\\layout.jade":1418530485042},"keybinding-resolver":{},"metrics":{"sessionLength":431701},"tree-view":{"directoryExpansionStates":{},"selectedPath":"c:\\Users\\LESANC~1\\AppData\\Local\\Temp\\scp04822\\home\\ec2-user\\webapp\\views","hasFocus":false,"attached":true,"scrollLeft":0,"scrollTop":0,"width":163},"find-and-replace":{"viewState":"","modelState":{"useRegex":false,"inCurrentSelection":false,"caseSensitive":false,"wholeWord":false},"projectViewState":"","resultsModelState":{"useRegex":false,"caseSensitive":false},"findHistory":["ベスエロ"],"replaceHistory":["べすえろ"],"pathsHistory":["べすえろ"]}}}